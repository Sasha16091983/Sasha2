# Практичне резервне копіювання, відновлення та міграція бази даних

Цей документ містить практичні інструкції та команди для резервного копіювання, відновлення та міграції баз даних MySQL.

## 1. Резервне копіювання бази даних

### 1.1. Повне резервне копіювання за допомогою mysqldump

```bash
# Резервне копіювання всієї бази даних
mysqldump -u адмін -p навчальна_база > навчальна_база_backup.sql

# Резервне копіювання з додатковими опціями (структура та дані)
mysqldump -u адмін -p --opt навчальна_база > навчальна_база_повна.sql

# Резервне копіювання кількох баз даних
mysqldump -u адмін -p --databases навчальна_база тестова_база > кілька_баз.sql

# Резервне копіювання всіх баз даних
mysqldump -u адмін -p --all-databases > всі_бази.sql
```

### 1.2. Резервне копіювання окремих таблиць

```bash
# Резервне копіювання конкретної таблиці
mysqldump -u адмін -p навчальна_база співробітники > співробітники_backup.sql

# Резервне копіювання кількох таблиць
mysqldump -u адмін -p навчальна_база співробітники відділи > вибрані_таблиці.sql
```

### 1.3. Резервне копіювання лише структури або лише даних

```bash
# Резервне копіювання лише структури (без даних)
mysqldump -u адмін -p --no-data навчальна_база > структура_бази.sql

# Резервне копіювання лише даних (без структури)
mysqldump -u адмін -p --no-create-info навчальна_база > дані_бази.sql
```

### 1.4. Стиснення резервних копій

```bash
# Резервне копіювання зі стисненням
mysqldump -u адмін -p навчальна_база | gzip > навчальна_база_backup.sql.gz

# Розпакування стисненої резервної копії
gunzip < навчальна_база_backup.sql.gz > навчальна_база_backup.sql
```

### 1.5. Автоматизація резервного копіювання

```bash
# Створення скрипту для щоденного резервного копіювання
cat > backup_script.sh << 'EOF'
#!/bin/bash
DATE=$(date +%Y-%m-%d)
BACKUP_DIR="/шлях/до/резервних/копій"

# Створення каталогу для резервних копій, якщо він не існує
mkdir -p $BACKUP_DIR

# Резервне копіювання бази даних
mysqldump -u адмін -p'пароль' --opt навчальна_база | gzip > $BACKUP_DIR/навчальна_база_$DATE.sql.gz

# Видалення резервних копій старших за 30 днів
find $BACKUP_DIR -name "навчальна_база_*.sql.gz" -type f -mtime +30 -delete
EOF

# Надання прав на виконання скрипту
chmod +x backup_script.sh

# Додавання скрипту до планувальника cron (запуск щодня о 2:00)
# 0 2 * * * /шлях/до/backup_script.sh
```

## 2. Відновлення бази даних

### 2.1. Відновлення з резервної копії

```bash
# Створення нової бази даних для відновлення
mysql -u адмін -p -e "CREATE DATABASE відновлена_база;"

# Відновлення бази даних з резервної копії
mysql -u адмін -p відновлена_база < навчальна_база_backup.sql

# Відновлення зі стисненої резервної копії
gunzip < навчальна_база_backup.sql.gz | mysql -u адмін -p відновлена_база
```

### 2.2. Відновлення окремих таблиць

```bash
# Відновлення окремої таблиці
mysql -u адмін -p відновлена_база < співробітники_backup.sql
```

### 2.3. Відновлення з точкою у часі (Point-in-Time Recovery)

```bash
# Відновлення бази даних до певного моменту часу (потребує бінарного журналу)
mysql -u адмін -p відновлена_база < повна_резервна_копія.sql

mysqlbinlog --stop-datetime="2023-05-15 14:30:00" /var/log/mysql/mysql-bin.* | mysql -u адмін -p відновлена_база
```

## 3. Міграція бази даних

### 3.1. Міграція між серверами MySQL

```bash
# Пряма міграція між серверами
mysqldump -h старий_сервер -u адмін -p навчальна_база | mysql -h новий_сервер -u адмін -p навчальна_база

# Міграція з проміжним файлом
mysqldump -h старий_сервер -u адмін -p навчальна_база > міграція.sql
mysql -h новий_сервер -u адмін -p навчальна_база < міграція.sql
```

### 3.2. Міграція між різними версіями MySQL

```bash
# Експорт з урахуванням сумісності
mysqldump -u адмін -p --compatible=mysql40 навчальна_база > сумісна_міграція.sql

# Імпорт на новий сервер
mysql -u адмін -p навчальна_база < сумісна_міграція.sql
```

### 3.3. Міграція між різними СУБД

```bash
# Експорт даних у CSV-формат для міграції в іншу СУБД
mysql -u адмін -p -e "SELECT * FROM співробітники INTO OUTFILE '/tmp/співробітники.csv' FIELDS TERMINATED BY ',' ENCLOSED BY '\"' LINES TERMINATED BY '\n';" навчальна_база

# Приклад імпорту в PostgreSQL
# psql -U postgres -d цільова_база -c "\copy співробітники FROM '/tmp/співробітники.csv' WITH CSV HEADER"
```

## 4. Перевірка цілісності даних

```sql
-- Перевірка таблиць після відновлення
CHECK TABLE співробітники;

-- Оптимізація таблиць після відновлення
OPTIMIZE TABLE співробітники;

-- Аналіз таблиць для оновлення статистики
ANALYZE TABLE співробітники;
```

## 5. Стратегії резервного копіювання

### 5.1. Повне, диференціальне та інкрементне резервне копіювання

```bash
# Повне резервне копіювання (щотижня, наприклад, у неділю)
mysqldump -u адмін -p --opt навчальна_база > повне_$(date +%Y-%m-%d).sql

# Інкрементне резервне копіювання (щодня) - потребує налаштованого бінарного журналу
mysqlbinlog --start-datetime="$(date -d 'yesterday' +%Y-%m-%d) 00:00:00" /var/log/mysql/mysql-bin.* > інкрементне_$(date +%Y-%m-%d).sql
```

### 5.2. Стратегія 3-2-1 для резервного копіювання

```bash
# Створення трьох копій (локальна, мережева, хмарна)

# 1. Локальна копія
mysqldump -u адмін -p навчальна_база > /локальне_сховище/навчальна_база_$(date +%Y-%m-%d).sql

# 2. Мережева копія (NAS або інший сервер)
scp /локальне_сховище/навчальна_база_$(date +%Y-%m-%d).sql користувач@мережевий_сервер:/шлях/до/сховища/

# 3. Хмарна копія (наприклад, AWS S3)
aws s3 cp /локальне_сховище/навчальна_база_$(date +%Y-%m-%d).sql s3://моє-сховище-резервних-копій/
```

## 6. Практичні рекомендації

1. **Регулярно тестуйте відновлення** - створюйте тестове середовище для перевірки процесу відновлення
2. **Документуйте процедури** - зберігайте детальні інструкції з резервного копіювання та відновлення
3. **Автоматизуйте процеси** - використовуйте скрипти та планувальники для автоматизації резервного копіювання
4. **Моніторте процес** - налаштуйте сповіщення про успішне/невдале резервне копіювання
5. **Шифруйте резервні копії** - захищайте конфіденційні дані в резервних копіях

```bash
# Шифрування резервної копії
mysqldump -u адмін -p навчальна_база | openssl enc -aes-256-cbc -salt -out навчальна_база_encrypted.sql.enc -k пароль_шифрування

# Розшифрування резервної копії
openssl enc -d -aes-256-cbc -in навчальна_база_encrypted.sql.enc -k пароль_шифрування | mysql -u адмін -p відновлена_база
```

## Висновок

Регулярне резервне копіювання та перевірка процедур відновлення є критично важливими для забезпечення безпеки даних та безперервності бізнес-процесів. Правильно налаштована стратегія резервного копіювання повинна враховувати специфіку вашої бази даних, вимоги до часу відновлення (RTO) та допустимої втрати даних (RPO).